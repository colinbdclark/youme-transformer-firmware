# YouMe Transformer Firmware

## Credits

The YouMe Transformer hardware was designed by Colin Clark Colin Clark of [Lichen Community Systems Worker Cooperative Canada](https://lichen.coop). The firmware was developed by [Tony Atkins](https://github.com/duhrer).

## License

This repository is released under the BSD-3 license.


## Compiling the YouMe Transformer Firmware

### Prerequisites

1. Git
2. CMake
3. Docker and/or the Pi Pico SDK toolchain

### Install OpenOCD, Picotool, and the Compiler Toolchain

Raspberry Pi has provided a [Getting Started with Raspberry Pi Pico-series](https://pip-assets.raspberrypi.com/categories/610-raspberry-pi-pico/documents/RP-008276-DS-1-getting-started-with-pico.pdf) PDF that walks through the process of installing the necessary dependencies manually.

#### Recommended: Use the Raspberry Pi Pico VS Code Extension

If you use VS Code, there is a Raspberry Pi Pico extension that will automatically install or update the Pico SDK, toolchain, OpenOCD, picotool, CMake, and other necessary dependencies in ```~/.pico-sdk```.

1. Open VS Code
2. Install the official "Raspberry Pi Pico" extension from Raspberry Pi.
3. Open the Raspberry Pi Pico Project: Quick Access panel
4. Generate a new C/C++Pico project, which will cause the extension to install all necessary dependencies
5. Delete the project
6. Set your environment variables to point to the correct versions of the SDK, OpenOCD, and the ARM toolchain as described below.

#### Other Ways

##### Windows

Nikhil Dabas provides a [Windows GUI installer for the Pico toolchain](https://www.raspberrypi.com/news/raspberry-pi-pico-windows-installer/).

##### Raspberry Pi OS

Raspberry Pi provides a [setup script for Raspberry Pi OS-based Linux](https://github.com/raspberrypi/pico-setup).

### Update Submodules

Init and recursively update all submodules:
```git submodule update --init --recursive```

### Set Environment Variables

The following environment variables need to be set:

The following environment variables need to be set:

1. ```PICO_OPENOCD_PATH``` should point to a directory containing an RP2350-compatible version of OpenOCD (which should contain both the openocd binary and its scripts directory). On macOS, the VS Code extension will install this in ```~/.pico-sdk/openocd/<version>```.
2. ```PICO_TOOLCHAIN_PATH``` should point to a directory containing the arm-eabi-none GCC cross-compiler. On macOS, the VS Code extension will install this in ```~/.pico-sdk/toolchain/<version>```.
3. ```picotool_DIR``` should be set if you don't have picotool installed globally (the default if installed by the VS Code extension) and don't want it to be downloaded each time you build the project. On macOS, the VS Code extension will install picotool in ```~/.sdk/picotool/<version>```

#### Example Environment Variables

```sh
PICO_TOOLS_PATH=~/.pico-sdk
export PICO_SDK_PATH=$PICO_TOOLS_PATH/sdk/2.2.0
export PICO_TOOLCHAIN_PATH=$PICO_TOOLS_PATH/toolchain/14_2_Rel1
export PICO_OPENOCD_PATH=$PICO_TOOLS_PATH/openocd/0.12.0+dev
export picotool_DIR=$PICO_TOOLS_PATH/picotool/2.2.0-a4
```

### Configuring the Build

#### Release and Debug Builds

The CMake build is set up to build optimized Debug versions by default. To build an unoptimized debug build, include ```-DPICO_DEOPTIMIZED_DEBUG=1``` when you invoke the compile script (or CMake directly). A Release build can be generated by specifying ```-DCMAKE_BUILD_TYPE=Release```.

### Compilation

The firmware can be compiled either in a Docker container or using a locally-installed version of the Pi Pico development toolchain. Flashing the firmware is be done locally using the Pico fork of OpenOCD.

Support for building and remote debugging the firmware in VS Code is also included.

#### Compile Locally in the Shell

Assuming the necessary toolchain is installed, a couple of scripts are provided for compiling locally:

##### Compile the Firmware

```sh
./compile.sh
```

##### Manually install the Firmware

1. Ensure power to the board is disconnected
2. Hold down the SW1 button on the board
3. Connect power
4. A volume named RP2350 should be mounted on your file system
5. Copy ```build/youme-transformer.uf2``` to the RP2350 volume

##### Flash the Firmware using a Pico Debugger

```sh
./flash-firmware.sh build/youme-transformer.elf
```

##### Clean Up the Build Artifacts

```sh
./clean.sh
```

#### Building and Debugging with VS Code

You'll need a Pi Pico Probe connected to your computer, and your Pico board should also be connected via USB. The project is set up with OpenOCD acting as a debug server for arm-eabi-none-gdb running on your computer.

Build tasks have been defined for building unoptimized Debug builds and Release builds.

The CMake extension for VS Code has been set up as well, and can be used to invoke a build from the Command Palette by first choosing "CMake: Configure" and then "CMake: Build". See ```.vscode/settings.json``` for the CMake extension's settings.

#### Compile with Docker

The Docker image contains the Pi Pico cross-compilation toolchain pre-installed, so you don't need to have it installed locally (unless you want use a debugger). It assumes you will bind mount the project directory as a volume in the Docker container.

##### Build the Docker Image

```sh
docker build . -t youme-transformer
```

##### Compile the Firwmware

```sh
docker run -v `pwd`:/project --rm youme-transformer ./docker-compile.sh
```

##### Run an interactive shell in the container

```sh
docker run -v `pwd`:/project -it --rm youme-transformer
```

Updating

If you need to update to a newer version of the Pico SDK, here's the process for updating the submodules:

### Update the pico-sdk Submodule

```sh
cd lib/pico-sdk

# Fetch new tags from the pico-sdk repository
# and check out the version you want to upgrade to.
# After, you'll be in a detached head state.
# That is ok.
git fetch --tags
git checkout <pico-sdk-release-tag-name>

# Update all of Pico SDK's submodules
git submodule update --init --recursive

# Go back to the repository's top level
# and commit the submodule's changes.
cd ../..
git add lib/pico-sdk
git commit
```

### Update the Tags Used in the Dockerfile

The Docker file specifies tag versions for pico-sdk and picotool. These lines should be updated accordingly:

```dockerfile
RUN git clone https://github.com/raspberrypi/pico-sdk.git --branch 2.2.0

...

RUN git clone https://github.com/raspberrypi/picotool.git --branch 2.2.0-a4
```
